<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Temukan Pemilik Bandul</title>
    <style>
      :root {
        --bg: #121212;
        --panel: #1b1b1b;
        --fg: #ffffff;
        --accent: #8a4eff;
        --danger: #ff3b3b;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 1rem;
        background: var(--bg);
        color: var(--fg);
        font-family: Inter, "Segoe UI", Roboto, sans-serif;
      }

      .panel {
        width: min(94vw, 760px);
        background: var(--panel);
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 18px;
        padding: clamp(1rem, 3vw, 2rem);
        text-align: center;
      }

      h1 {
        margin: 0;
        font-size: clamp(1.3rem, 2.2vw, 1.8rem);
        font-weight: 600;
        letter-spacing: 0.01em;
      }

      .subtitle {
        margin: 0.6rem auto 1.2rem;
        max-width: 60ch;
        opacity: 0.86;
        font-size: 0.95rem;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        margin: -1px;
        padding: 0;
        border: 0;
        clip: rect(0, 0, 0, 0);
        overflow: hidden;
      }

      .input-row {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 1rem;
      }

      .input-stack {
        width: min(92vw, 300px);
      }

      .box-strip {
        display: grid;
        grid-template-columns: repeat(4, 2.4ch) 1.4ch repeat(4, 2.4ch) 1.4ch repeat(4, 2.4ch);
        justify-content: center;
        align-items: center;
        gap: 0.35ch;
        margin-bottom: 0.52rem;
        pointer-events: none;
      }

      .char-box {
        width: 2.4ch;
        height: 2.4ch;
        border: 1px solid rgba(255, 255, 255, 0.34);
        border-radius: 0.35rem;
        background: rgba(255, 255, 255, 0.06);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transform-origin: center;
        overflow: hidden;
      }

      .char-box.filled {
        border-color: rgba(138, 78, 255, 0.92);
        background: rgba(138, 78, 255, 0.14);
      }

      .char-box-char {
        display: inline-block;
        font-size: 0.9rem;
        line-height: 1;
        transform-origin: center;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      }

      .separator {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin: 0 0.4ch;
        opacity: 0.5;
        font-size: 1rem;
      }

      .char-box.anim-in {
        animation: boxIn 0.24s cubic-bezier(0.2, 1.2, 0.3, 1) both;
      }

      .char-box.anim-out {
        animation: boxOut 150ms cubic-bezier(0.4, 0, 1, 1) both;
      }

      .char-box.verifying-active {
        animation: rotatePulse 260ms ease-in-out both;
      }

      .char-box.verifying-active .char-box-char {
        animation: counterPulse 260ms ease-in-out both;
      }

      .char-box.pulse,
      .char-box.intro {
        animation: rotatePulse 360ms ease-in-out both;
        animation-delay: var(--pulse-delay, 0ms);
      }

      .char-box.pulse .char-box-char,
      .char-box.intro .char-box-char {
        animation: counterPulse 360ms ease-in-out both;
        animation-delay: var(--pulse-delay, 0ms);
      }

      @keyframes boxIn {
        from {
          opacity: 0;
          transform: translateY(10px) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes boxOut {
        from {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        to {
          opacity: 0;
          transform: translateY(10px) scale(0.9);
        }
      }

      @keyframes rotatePulse {
        0% {
          transform: rotate(0deg);
        }
        50% {
          transform: rotate(44deg);
        }
        100% {
          transform: rotate(0deg);
        }
      }

      @keyframes counterPulse {
        0% {
          transform: rotate(0deg);
        }
        50% {
          transform: rotate(-44deg);
        }
        100% {
          transform: rotate(0deg);
        }
      }

      .field-shell {
        width: min(92vw, 300px);
        position: relative;
        margin: 0 auto;
        transition: border-color 180ms ease, box-shadow 180ms ease;
        border: 1px solid rgba(255, 255, 255, 0.35);
        border-radius: 14px;
        background: #171717;
      }

      .field-shell.complete {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(138, 78, 255, 0.25), 0 0 16px rgba(138, 78, 255, 0.24);
      }

      .field-shell.error {
        border-color: var(--danger);
        box-shadow: 0 0 0 1px rgba(255, 59, 59, 0.28), 0 0 16px rgba(255, 59, 59, 0.2);
      }

      .char-box.error {
        border-color: var(--danger);
        box-shadow: 0 0 0 1px rgba(255, 59, 59, 0.2);
      }

      .char-box.warning-empty {
        border-color: var(--danger);
        background: rgba(255, 59, 59, 0.18);
        box-shadow: 0 0 0 1px rgba(255, 59, 59, 0.2);
      }

      .field {
        position: relative;
        z-index: 1;
        width: 100%;
        border: none;
        border-radius: 14px;
        background: transparent;
        color: var(--fg);
        padding: 0.86rem 1rem;
        font-size: clamp(1rem, 2.8vw, 1.15rem);
        letter-spacing: 0.08em;
        text-align: center;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      }

      .field::placeholder {
        color: rgba(255, 255, 255, 0.35);
        letter-spacing: 0.08em;
      }

      .field:focus {
        outline: none;
      }

      .actions {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.55rem;
      }

      .clear-btn {
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: transparent;
        color: var(--fg);
        border-radius: 10px;
        width: 2.7rem;
        height: 2.7rem;
        display: grid;
        place-items: center;
        cursor: pointer;
        font-size: 1rem;
        line-height: 1;
      }

      .clear-btn:disabled {
        opacity: 0.45;
        cursor: not-allowed;
      }

      .btn-primary {
        border: 0;
        border-radius: 12px;
        padding: 0.74rem 1.2rem;
        min-height: 2.7rem;
        font-size: 0.95rem;
        font-weight: 600;
        background: var(--accent);
        color: var(--fg);
        cursor: pointer;
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .status {
        margin-top: 0.8rem;
        min-height: 1.2rem;
        font-size: 0.92rem;
        opacity: 0.92;
      }
    </style>
  </head>
  <body>
    <section class="panel">
      <h1>Temukan Pemilik Bandul</h1>
      <p class="subtitle">Masukkan kode bandul 12 karakter untuk melihat profil pemilik terdaftar.</p>

      <label for="codeInput" class="sr-only">Kode bandul 12 karakter</label>
      <div class="input-row">
        <div class="input-stack">
          <div id="boxStrip" class="box-strip" aria-hidden="true">
            <div class="char-box" data-slot="0"><span class="char-box-char"></span></div>
            <div class="char-box" data-slot="1"><span class="char-box-char"></span></div>
            <div class="char-box" data-slot="2"><span class="char-box-char"></span></div>
            <div class="char-box" data-slot="3"><span class="char-box-char"></span></div>
            <span class="separator" aria-hidden="true">—</span>
            <div class="char-box" data-slot="4"><span class="char-box-char"></span></div>
            <div class="char-box" data-slot="5"><span class="char-box-char"></span></div>
            <div class="char-box" data-slot="6"><span class="char-box-char"></span></div>
            <div class="char-box" data-slot="7"><span class="char-box-char"></span></div>
            <span class="separator" aria-hidden="true">—</span>
            <div class="char-box" data-slot="8"><span class="char-box-char"></span></div>
            <div class="char-box" data-slot="9"><span class="char-box-char"></span></div>
            <div class="char-box" data-slot="10"><span class="char-box-char"></span></div>
            <div class="char-box" data-slot="11"><span class="char-box-char"></span></div>
          </div>

          <div id="fieldShell" class="field-shell">
            <input
              id="codeInput"
              class="field"
              type="text"
              inputmode="text"
              autocomplete="off"
              autocapitalize="off"
              spellcheck="false"
              autocorrect="off"
              maxlength="12"
              aria-describedby="status"
              placeholder="XXXX-XXXX-XXXX"
            />
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="clearBtn" type="button" class="clear-btn" aria-label="Hapus kode">✕</button>
        <button id="submitBtn" type="button" class="btn-primary">Lihat Profil Pemilik</button>
      </div>
      <p id="status" class="status" aria-live="polite"></p>
    </section>

    <script>
      const MAX_LEN = 12;
      const codeInput = document.getElementById('codeInput');
      const clearBtn = document.getElementById('clearBtn');
      const submitBtn = document.getElementById('submitBtn');
      const statusEl = document.getElementById('status');
      const fieldShell = document.getElementById('fieldShell');
      const boxStrip = document.getElementById('boxStrip');
      const boxEls = Array.from(boxStrip.querySelectorAll('.char-box'));

      // state (raw/prevRaw/timers)
      let rawCode = '';
      let prevRaw = '';
      let isSubmitting = false;
      let introRunning = true;
      let isClearing = false;
      let verifyingInterval = null;
      const pendingTimeouts = new Set();

      const VERIFY_STEP_MS = 100;
      const CLEAR_STAGGER_MS = 50;
      const VERIFY_SEQUENCE = [...Array(MAX_LEN).keys(), ...Array(MAX_LEN).keys()].map((_, idx) =>
        idx < MAX_LEN ? idx : (MAX_LEN - 1) - (idx - MAX_LEN)
      );

      function scheduleTimeout(callback, delay) {
        const id = window.setTimeout(() => {
          pendingTimeouts.delete(id);
          callback();
        }, delay);
        pendingTimeouts.add(id);
        return id;
      }

      function clearPendingTimeouts() {
        pendingTimeouts.forEach((id) => window.clearTimeout(id));
        pendingTimeouts.clear();
      }

      function wait(delay) {
        return new Promise((resolve) => {
          scheduleTimeout(resolve, delay);
        });
      }

      // sanitize+limit
      function sanitizeRaw(value) {
        return String(value || '').replace(/[-\s]/g, '').slice(0, MAX_LEN);
      }

      function clearTransientBoxClasses(box) {
        box.classList.remove('anim-in', 'anim-out', 'pulse', 'intro', 'verifying-active', 'warning-empty');
        box.style.removeProperty('--pulse-delay');
      }

      // render
      function applyFieldState(nextRaw = rawCode) {
        const length = nextRaw.length;
        fieldShell.classList.toggle('complete', length === MAX_LEN && !fieldShell.classList.contains('error'));
        codeInput.disabled = isSubmitting || introRunning || isClearing;
        clearBtn.disabled = length === 0 || isSubmitting || introRunning || isClearing;
        submitBtn.disabled = isSubmitting || introRunning || isClearing;
      }

      function instantRender(raw = rawCode) {
        for (let i = 0; i < MAX_LEN; i += 1) {
          const box = boxEls[i];
          const charEl = box.querySelector('.char-box-char');
          const char = raw[i] || '';
          clearTransientBoxClasses(box);
          charEl.textContent = char;
          box.classList.toggle('filled', Boolean(char));
        }
        applyFieldState(raw);
      }

      function removeErrorStyles() {
        fieldShell.classList.remove('error');
        boxEls.forEach((box) => box.classList.remove('error'));
        applyFieldState(rawCode);
      }

      // animateIn
      function animateIn(slotIndex) {
        const box = boxEls[slotIndex];
        if (!box) return;
        box.classList.remove('anim-in');
        void box.offsetWidth;
        box.classList.add('anim-in');
        box.addEventListener('animationend', () => box.classList.remove('anim-in'), { once: true });
      }

      // animateOut
      function animateOut(slotIndex, char = '') {
        const box = boxEls[slotIndex];
        if (!box) return Promise.resolve();

        const charEl = box.querySelector('.char-box-char');
        charEl.textContent = char;
        box.classList.add('filled');
        box.classList.remove('anim-out');
        void box.offsetWidth;
        box.classList.add('anim-out');

        return new Promise((resolve) => {
          const cleanup = () => {
            box.classList.remove('anim-out');
            if (!rawCode[slotIndex]) {
              charEl.textContent = '';
              box.classList.remove('filled');
            }
            resolve();
          };
          box.addEventListener('animationend', cleanup, { once: true });
        });
      }

      // completePulse
      function completePulse() {
        for (let i = MAX_LEN - 1; i >= 0; i -= 1) {
          const box = boxEls[i];
          if (!box.classList.contains('filled')) continue;
          const delay = (MAX_LEN - 1 - i) * 36;
          box.style.setProperty('--pulse-delay', `${delay}ms`);
          box.classList.remove('pulse');
          void box.offsetWidth;
          box.classList.add('pulse');
        }
      }


      function runIntroAnimation() {
        const stagger = 60;
        const pulseDuration = 360;

        for (let i = MAX_LEN - 1; i >= 0; i -= 1) {
          const box = boxEls[i];
          const delay = (MAX_LEN - 1 - i) * stagger;
          box.style.setProperty('--pulse-delay', `${delay}ms`);
          box.classList.remove('intro');
          void box.offsetWidth;
          box.classList.add('intro');

          window.setTimeout(() => {
            box.classList.remove('intro');
            box.style.removeProperty('--pulse-delay');
          }, delay + pulseDuration);
        }

        window.setTimeout(() => {
          introRunning = false;
          codeInput.disabled = false;
          applyFieldState(rawCode);
        }, ((MAX_LEN - 1) * stagger) + pulseDuration + 20);
      }

      function stopVerifying() {
        if (verifyingInterval) {
          window.clearInterval(verifyingInterval);
          verifyingInterval = null;
        }
        boxEls.forEach((box) => box.classList.remove('verifying-active'));
      }

      // startVerifying/stopVerifying
      function startVerifying() {
        stopVerifying();
        let step = 0;
        verifyingInterval = window.setInterval(() => {
          const index = VERIFY_SEQUENCE[step % VERIFY_SEQUENCE.length];
          const box = boxEls[index];
          if (!box) return;
          box.classList.remove('verifying-active');
          void box.offsetWidth;
          box.classList.add('verifying-active');
          step += 1;
        }, VERIFY_STEP_MS);
      }

      async function warningIncomplete() {
        const start = rawCode.length;
        for (let i = start; i < MAX_LEN; i += 1) {
          scheduleTimeout(() => {
            const box = boxEls[i];
            box.classList.add('warning-empty');
            box.classList.remove('verifying-active');
            void box.offsetWidth;
            box.classList.add('verifying-active');
          }, (i - start) * 38);
        }

        await wait(((MAX_LEN - start) * 38) + 320);
        for (let i = start; i < MAX_LEN; i += 1) {
          const box = boxEls[i];
          box.classList.remove('warning-empty', 'verifying-active');
        }
      }

      async function clearFromEndToStart() {
        const snapshot = rawCode;
        if (!snapshot.length) return;

        isClearing = true;
        applyFieldState(snapshot);

        const tasks = [];
        for (let i = snapshot.length - 1; i >= 0; i -= 1) {
          tasks.push(new Promise((resolve) => {
            scheduleTimeout(async () => {
              rawCode = rawCode.slice(0, i);
              prevRaw = rawCode;
              await animateOut(i, snapshot[i]);
              resolve();
            }, (snapshot.length - 1 - i) * CLEAR_STAGGER_MS);
          }));
        }

        await Promise.all(tasks);
        rawCode = '';
        prevRaw = '';
        codeInput.value = '';
        instantRender('');
        isClearing = false;
        applyFieldState('');
      }

      async function runInvalidPingpongOnce() {
        for (let step = 0; step < VERIFY_SEQUENCE.length; step += 1) {
          const index = VERIFY_SEQUENCE[step];
          const box = boxEls[index];
          box.classList.remove('verifying-active');
          void box.offsetWidth;
          box.classList.add('verifying-active');
          await wait(VERIFY_STEP_MS);
        }
      }

      // handleInvalidResult (one-cycle pingpong + clear)
      async function handleInvalidResult(type) {
        stopVerifying();
        fieldShell.classList.add('error');
        boxEls.forEach((box) => box.classList.add('error'));

        await runInvalidPingpongOnce();
        stopVerifying();
        await clearFromEndToStart();

        isSubmitting = false;
        applyFieldState(rawCode);

        statusEl.textContent = type === 'inactive' ? 'Kode tidak aktif.' : 'Kode tidak ditemukan.';
      }

      codeInput.addEventListener('input', () => {
        if (isSubmitting || introRunning || isClearing) return;

        if (fieldShell.classList.contains('error') && codeInput.value.length > 0) {
          removeErrorStyles();
        }

        // core input render logic
        const raw = sanitizeRaw(codeInput.value);
        if (codeInput.value !== raw) {
          codeInput.value = raw;
        }

        const wasFull = prevRaw.length === MAX_LEN;

        // animate only on simple append/delete at end
        if (raw.length === prevRaw.length + 1 && raw.startsWith(prevRaw)) {
          rawCode = raw;
          instantRender(raw);
          animateIn(prevRaw.length);
        } else if (raw.length === prevRaw.length - 1 && prevRaw.startsWith(raw)) {
          const removedIndex = raw.length;
          const removedChar = prevRaw[removedIndex] || '';
          rawCode = raw;
          instantRender(raw);
          animateOut(removedIndex, removedChar);
        } else {
          rawCode = raw;
          instantRender(raw);
        }

        if (!wasFull && raw.length === MAX_LEN) {
          completePulse();
        }

        prevRaw = raw;
      });


      fieldShell.addEventListener('click', () => {
        if (introRunning || isSubmitting) return;
        codeInput.focus({ preventScroll: true });
      });

      codeInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          submitBtn.click();
        }
      });

      clearBtn.addEventListener('click', () => {
        if (isSubmitting || introRunning || isClearing) return;
        stopVerifying();
        clearPendingTimeouts();
        statusEl.textContent = '';
        removeErrorStyles();

        (async () => {
          await clearFromEndToStart();
          codeInput.focus({ preventScroll: true });
        })();
      });

      submitBtn.addEventListener('click', async () => {
        if (isSubmitting || introRunning || isClearing) return;

        if (rawCode.length < MAX_LEN) {
          statusEl.textContent = 'Kode belum lengkap. Pastikan 12 karakter ya.';
          await warningIncomplete();
          return;
        }

        isSubmitting = true;
        stopVerifying();
        clearPendingTimeouts();
        statusEl.textContent = 'Memproses pencarian...';
        applyFieldState(rawCode);
        startVerifying();

        try {
          const response = await fetch('/api/lookup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: rawCode }),
          });

          const payload = await response.json();
          stopVerifying();

          if (response.ok && payload.ok && payload.redirect) {
            window.location.href = payload.redirect;
            return;
          }

          if (response.status === 404) {
            await handleInvalidResult('not_found');
            return;
          }

          if (response.status === 410) {
            await handleInvalidResult('inactive');
            return;
          }

          statusEl.textContent = 'Maaf, terjadi kendala saat memproses kode. Silakan coba lagi.';
        } catch (_error) {
          stopVerifying();
          statusEl.textContent = 'Tidak bisa terhubung ke server. Periksa koneksi lalu coba lagi.';
        } finally {
          if (!isSubmitting) return;
          stopVerifying();
          isSubmitting = false;
          applyFieldState(rawCode);
        }
      });

      window.addEventListener('beforeunload', () => {
        stopVerifying();
        clearPendingTimeouts();
      });

      codeInput.disabled = true;
      instantRender('');
      runIntroAnimation();
    </script>
  </body>
</html>
