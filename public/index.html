<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Temukan Pemilik Bandul</title>
    <style>
      :root {
        --bg: #121212;
        --panel: #1b1b1b;
        --fg: #ffffff;
        --accent: #8a4eff;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 1rem;
        background: var(--bg);
        color: var(--fg);
        font-family: Inter, "Segoe UI", Roboto, sans-serif;
      }

      .panel {
        width: min(94vw, 760px);
        background: var(--panel);
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 18px;
        padding: clamp(1rem, 3vw, 2rem);
        text-align: center;
      }

      h1 {
        margin: 0;
        font-size: clamp(1.3rem, 2.2vw, 1.8rem);
        font-weight: 600;
        letter-spacing: 0.01em;
      }

      .subtitle {
        margin: 0.6rem auto 1.2rem;
        max-width: 60ch;
        opacity: 0.86;
        font-size: 0.95rem;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        margin: -1px;
        padding: 0;
        border: 0;
        clip: rect(0, 0, 0, 0);
        overflow: hidden;
      }

      .input-row {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 1rem;
      }

      .grow-shell {
        width: min(92vw, 460px);
        display: flex;
        justify-content: center;
      }

      .grow-track {
        width: 100%;
        transform-origin: center center;
        will-change: transform, opacity;
        transition: transform 220ms ease, opacity 220ms ease, filter 220ms ease;
      }

      .input-field {
        width: 100%;
        border: 1px solid rgba(255, 255, 255, 0.35);
        border-radius: 12px;
        background: #171717;
        color: var(--fg);
        padding: 0.78rem 0.92rem;
        font-size: clamp(1rem, 2.8vw, 1.15rem);
        letter-spacing: 0.08em;
        text-align: center;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      }

      .input-field:focus {
        outline: none;
        border-color: rgba(138, 78, 255, 0.7);
      }

      .grow-track.complete .input-field {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(138, 78, 255, 0.25), 0 0 16px rgba(138, 78, 255, 0.24);
      }

      .actions {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.55rem;
      }

      .clear-btn {
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: transparent;
        color: var(--fg);
        border-radius: 10px;
        width: 2.7rem;
        height: 2.7rem;
        display: grid;
        place-items: center;
        cursor: pointer;
        font-size: 1rem;
        line-height: 1;
      }

      .clear-btn:disabled {
        opacity: 0.45;
        cursor: not-allowed;
      }

      .btn-primary {
        border: 0;
        border-radius: 12px;
        padding: 0.74rem 1.2rem;
        min-height: 2.7rem;
        font-size: 0.95rem;
        font-weight: 600;
        background: var(--accent);
        color: var(--fg);
        cursor: pointer;
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .status {
        margin-top: 0.8rem;
        min-height: 1.2rem;
        font-size: 0.92rem;
        opacity: 0.92;
      }
    </style>
  </head>
  <body>
    <section class="panel">
      <h1>Temukan Pemilik Bandul</h1>
      <p class="subtitle">Masukkan kode bandul 12 karakter untuk melihat profil pemilik terdaftar.</p>

      <label for="codeInput" class="sr-only">Kode bandul 12 karakter</label>
      <div class="input-row">
        <div class="grow-shell">
          <div id="growTrack" class="grow-track">
            <input
              id="codeInput"
              class="input-field"
              type="text"
              inputmode="text"
              autocomplete="off"
              autocapitalize="off"
              spellcheck="false"
              autocorrect="off"
              placeholder="XXXX-XXXX-XXXX"
              aria-describedby="status"
            />
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="clearBtn" type="button" class="clear-btn" aria-label="Hapus kode">âœ•</button>
        <button id="submitBtn" type="button" class="btn-primary">Lihat Profil Pemilik</button>
      </div>
      <p id="status" class="status" aria-live="polite"></p>
    </section>

    <script>
      const MAX_LEN = 12;
      const MIN_SCALE = 0.15;
      const codeInput = document.getElementById('codeInput');
      const clearBtn = document.getElementById('clearBtn');
      const submitBtn = document.getElementById('submitBtn');
      const statusEl = document.getElementById('status');
      const growTrack = document.getElementById('growTrack');

      // Source of truth: rawCode always stores user code without hyphens/spaces.
      let rawCode = '';
      let isSubmitting = false;

      function sanitizeRaw(value) {
        return String(value || '').replace(/[-\s]/g, '').slice(0, MAX_LEN);
      }

      function formatCode(raw) {
        const first = raw.slice(0, 4);
        const second = raw.slice(4, 8);
        const third = raw.slice(8, 12);
        return [first, second, third].filter(Boolean).join('-');
      }

      function countRawBeforeCaret(text, caretPos) {
        const left = text.slice(0, Math.max(0, caretPos));
        return sanitizeRaw(left).length;
      }

      function mapRawIndexToFormattedIndex(rawIndex, formattedValue) {
        let seen = 0;
        for (let i = 0; i < formattedValue.length; i += 1) {
          if (formattedValue[i] !== '-') {
            seen += 1;
          }
          if (seen === rawIndex) {
            return i + 1;
          }
        }
        return formattedValue.length;
      }

      function applyGrowState() {
        const lengthForProgress = Math.max(rawCode.length, 1);
        const progress = Math.min(Math.max(lengthForProgress / MAX_LEN, 0), 1);
        const scale = MIN_SCALE + (1 - MIN_SCALE) * progress;

        growTrack.style.transform = `scaleX(${scale})`;
        growTrack.style.opacity = String(0.78 + progress * 0.22);
        growTrack.classList.toggle('complete', rawCode.length === MAX_LEN);
      }

      function syncInputDisplay(nextRaw, rawCaret) {
        rawCode = nextRaw;
        const formatted = formatCode(rawCode);
        codeInput.value = formatted;

        const safeRawCaret = Math.min(Math.max(rawCaret, 0), rawCode.length);
        const formattedCaret = mapRawIndexToFormattedIndex(safeRawCaret, formatted);

        // Keep mobile typing stable by always resetting caret after formatting.
        requestAnimationFrame(() => {
          codeInput.setSelectionRange(formattedCaret, formattedCaret);
        });

        clearBtn.disabled = rawCode.length === 0 || isSubmitting;
        submitBtn.disabled = isSubmitting;
        applyGrowState();
      }

      codeInput.addEventListener('input', () => {
        if (isSubmitting) return;

        const domValue = codeInput.value;
        const domCaret = codeInput.selectionStart ?? domValue.length;
        const nextRaw = sanitizeRaw(domValue);
        const rawCaret = Math.min(countRawBeforeCaret(domValue, domCaret), nextRaw.length);

        syncInputDisplay(nextRaw, rawCaret);
      });

      codeInput.addEventListener('paste', (event) => {
        if (isSubmitting) return;
        event.preventDefault();

        const pasted = event.clipboardData?.getData('text') || '';
        const selectionStart = codeInput.selectionStart ?? 0;
        const selectionEnd = codeInput.selectionEnd ?? selectionStart;
        const formatted = codeInput.value;

        const rawStart = countRawBeforeCaret(formatted, selectionStart);
        const rawEnd = countRawBeforeCaret(formatted, selectionEnd);

        const merged = `${rawCode.slice(0, rawStart)}${sanitizeRaw(pasted)}${rawCode.slice(rawEnd)}`.slice(0, MAX_LEN);
        const nextCaret = Math.min(rawStart + sanitizeRaw(pasted).length, merged.length);

        syncInputDisplay(merged, nextCaret);
      });

      clearBtn.addEventListener('click', () => {
        if (isSubmitting) return;
        statusEl.textContent = '';
        syncInputDisplay('', 0);
        codeInput.focus({ preventScroll: true });
      });

      submitBtn.addEventListener('click', async () => {
        if (isSubmitting) return;

        if (rawCode.length !== MAX_LEN) {
          statusEl.textContent = 'Kode harus berisi tepat 12 karakter.';
          return;
        }

        isSubmitting = true;
        clearBtn.disabled = true;
        submitBtn.disabled = true;
        statusEl.textContent = 'Memproses pencarian...';

        try {
          const response = await fetch('/api/lookup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: rawCode }),
          });

          const payload = await response.json();

          if (response.ok && payload.ok && payload.redirect) {
            window.location.href = payload.redirect;
            return;
          }

          if (response.status === 404) {
            statusEl.textContent = 'Kode tidak ditemukan. Coba periksa kembali kodenya.';
          } else if (response.status === 410) {
            statusEl.textContent = 'Kode ini sedang tidak aktif. Hubungi pemilik jika perlu.';
          } else {
            statusEl.textContent = 'Maaf, terjadi kendala saat memproses kode. Silakan coba lagi.';
          }
        } catch (_error) {
          statusEl.textContent = 'Tidak bisa terhubung ke server. Periksa koneksi lalu coba lagi.';
        } finally {
          isSubmitting = false;
          clearBtn.disabled = rawCode.length === 0;
          submitBtn.disabled = false;
        }
      });

      syncInputDisplay('', 0);
    </script>
  </body>
</html>
